# Импорт необходимых библиотек
import matplotlib.pyplot as plt  # Для построения графиков
from LU import LU_decompose, solve_system  # Импорт функций LU-разложения и решения СЛАУ
import numpy as np


# Функция метода наименьших квадратов
def least_squares(x, y, n):
    """
    Аппроксимация данных полиномом n-й степени методом наименьших квадратов
    Параметры:
        x: список значений x (независимая переменная)
        y: список значений y (зависимая переменная)
        n: степень аппроксимирующего полинома
    Возвращает:
        Коэффициенты полинома (начиная со свободного члена)
    """
    A = []  # Матрица системы нормальных уравнений
    b = []  # Вектор правой части системы

    # Формирование системы нормальных уравнений
    for k in range(n + 1):
        # Строка матрица A: суммы степеней x
        A.append([sum(map(lambda x: x ** (k + i), x)) for i in range(n + 1)])
        # Элемент вектора b: сумма произведений y на степени x
        b.append(sum(map(lambda x: x[0] * (x[1] ** k), zip(y, x))))

    # Решение системы методом LU-разложения
    L, U = LU_decompose(A)
    return solve_system(L, U, b)


# Функция вычисления значения полинома в точке
def polynom_value(coefficients, x):
    """
    Вычисление значения полинома в точке x
    Параметры:
        coefficients: список коэффициентов полинома (начиная со свободного члена)
        x: точка, в которой вычисляется значение
    Возвращает:
        Значение полинома в точке x
    """
    return sum([c * (x ** i) for i, c in enumerate(coefficients)])


# Функция вычисления суммы квадратов ошибок
def sum_squared_errors(x, y, coefficients):
    """
    Вычисление суммы квадратов отклонений
    Параметры:
        x: список значений x
        y: список значений y
        coefficients: коэффициенты аппроксимирующего полинома
    Возвращает:
        Сумму квадратов отклонений
    """
    # Вычисление предсказанных значений y
    y_computed = [polynom_value(coefficients, i) for i in x]
    # Сумма квадратов разностей между фактическими и предсказанными значениями
    return sum((a - b) ** 2 for a, b in zip(y, y_computed))


# Основная часть программы
if __name__ == '__main__':
    # Исходные данные
    x = [0.1, 0.5, 0.9, 1.3, 1.7, 2.1]  # Значения x
    y = [100.00, 4.0, 1.2346, 0.59172, 0.34602, 0.22676]  # Значения y

    # Создание фигуры для графика в стиле предыдущего кода
    plt.figure(figsize=(12, 8))

    # Отображение исходных данных
    plt.scatter(x, y, color='black', s=100, zorder=5, label='Узлы интерполяции')

    # Аппроксимация полиномом 1-й степени (линейная регрессия)
    print('Метод наименьших квадратов, степень = 1')
    ls1 = least_squares(x, y, 1)  # Получаем коэффициенты
    print(f'P(x) = {ls1[0]} + {ls1[1]}x')  # Вывод уравнения
    # Построение графика аппроксимирующей функции с плавной кривой
    x_plot = np.linspace(min(x), max(x), 300)
    y_plot1 = [polynom_value(ls1, x_i) for x_i in x_plot]
    plt.plot(x_plot, y_plot1, color='gray', linewidth=2, label='Степень = 1')
    print(f'Сумма квадратов ошибок = {sum_squared_errors(x, y, ls1)}')  # Вывод ошибки

    # Аппроксимация полиномом 2-й степени (квадратичная регрессия)
    print('\nМетод наименьших квадратов, степень = 2')
    ls2 = least_squares(x, y, 2)  # Получаем коэффициенты (оставляем оригинальную степень 3)
    print(f'P(x) = {ls2[0]} + {ls2[1]}x + {ls2[2]}x^2')  # Вывод уравнения
    # Построение графика аппроксимирующей функции
    y_plot2 = [polynom_value(ls2, x_i) for x_i in x_plot]
    plt.plot(x_plot, y_plot2, color='skyblue', linewidth=2, label='Степень = 2')
    print(f'Сумма квадратов ошибок = {sum_squared_errors(x, y, ls2)}')  # Вывод ошибки

    # Настройка графика в стиле предыдущего кода
    plt.title('Аппроксимация методом наименьших квадратов', fontsize=14)
    plt.xlabel('x', fontsize=12)
    plt.ylabel('y', fontsize=12)
    plt.legend(fontsize=10)
    plt.grid(True, alpha=0.3)
    plt.tight_layout()

    # Отображение графика
    plt.show()